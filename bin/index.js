#!/usr/bin/env node
/*!
@io-arc/static-files-meta-scraping
Analyze static files and extract meta information.

Version: 1.0.0
License: MIT
Documents: https://github.com/io-arc/static-files-meta-scraping

Copyright (c) 2021 arc one
*/
"use strict";var t=require("commander"),e=require("kleur"),r=require("update-notifier"),a=require("fs"),s=require("os"),i=require("path"),o=require("downloads-folder"),n=require("pug"),c=require("cheerio"),l=require("glob");function u(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var d=u(r),p=u(a),g=u(s),f=u(i),h=u(o),m=u(n),y=u(c),x=u(l);const v=[{target:"html[lang]",value:"lang"},{target:"head[prefix]",value:"prefix"},{target:"title"},{target:'meta[name="description"]'},{target:'meta[property="og:type"]'},{target:'meta[property="og:url"]'},{target:'meta[property="og:title"]'},{target:'meta[property="og:site_name"]'},{target:'meta[property="og:image"]'},{target:'meta[property="og:description"]'},{target:'meta[property="fb:app_id"]'},{target:'meta[name="twitter:card"]'},{target:'meta[name="twitter:site"]'},{target:'meta[name="twitter:creator"]'},{target:'meta[name="twitter:image"]'},{target:'meta[name="twitter:description"]'}],w=/\.[^.]+$/;class S{exit(t){console.log(e.red("Oops X(")),t&&console.log(e.red(JSON.stringify(t))),process.exit(1)}}class b extends S{#data;constructor(t){super();const e=this.#readFile();this.#data={search:e.search,ext:t.ext||e.ext||"html",dir:t.dir||e.dir||"dist"}}targetExt(){return this.#data.ext}targetDir(){return this.#data.dir}searchProperties(){return this.#data.search}#readFile=()=>{const t=f.default.join(process.cwd(),".meta-scraping.json");if(p.default.existsSync(t))return JSON.parse(p.default.readFileSync(t,"utf8"));const e=f.default.join(g.default.homedir(),".meta-scraping.json");return p.default.existsSync(e)?JSON.parse(p.default.readFileSync(e,"utf8")):{search:v}}}const q="https://github.com/io-arc/static-files-meta-scraping",j={doctype:"html"};class E extends S{#body;constructor(t,e){super();const r=m.default.compileFile(f.default.join(__dirname,"templates","base.pug"),j),a=this.#html(t,e);this.#body=r({htmlItems:a,project:f.default.dirname(q),homepage:q,version:"1.0.0"})}write(t){p.default.writeFileSync(`${f.default.join(t||h.default(),"result.html")}`,this.#body)}#html=(t,e)=>{const r=t.filter((t=>"html"===t.type)),a=[];return r.forEach((t=>{const r=[];e.forEach((e=>{const a=t.data.filter((t=>t.key===e.target)),s=[];a.forEach((t=>s.push(t.value))),r.push({key:e.target,value:s.join("<br>")})})),a.push({filename:t.filename,result:r})})),a}}class F extends S{#dir="";#files=[];constructor(t,e){super();const r=x.default.sync(`${t}/**/*.${/,/.test(e)?`{${e}}`:e}`);this.#files=this.#sort(r),this.#dir=t}exec(t){if(0===this.#files.length)return[];const e=[];return this.#files.forEach((r=>{const a=(t=>{const e=w.exec(t);if(null!=e)return e[0]})(r);if(null==a)return;const s=p.default.readFileSync(r,"utf8"),i=r.replace(`${this.#dir}/`,"");switch(a){case".css":return;default:const r=this.#html(s,t);return void e.push({filename:i,type:"html",data:r})}})),e}#sort=t=>t.sort(((t,e)=>{const r=w.exec(t),a=w.exec(e);if(!r)return a||t>e?-1:1;if(!a)return 1;const s=r[0],i=a[0];return s!==i?s>i?-1:1:t>e?-1:1}));#html=(t,e)=>{const r=y.default.load(t),a=[];return e.forEach((t=>{const e=r(t.target);if(0===e.length)return;const s=this.#attr(t);Array.from(e).forEach((e=>{const i=null==s?r(e).text():r(e).attr(s);null!=i&&a.push({key:t.target,value:i})}))})),a};#css=t=>{console.log(t)};#attr=t=>null!=t.value?""===t.value?null:t.value:/^meta/.test(t.target)?"content":/^link/.test(t.target)||/^a/.test(t.target)?"href":/^img\[srcset/.test(t.target)?"srcset":/^img/.test(t.target)||/^source/.test(t.target)||/^video/.test(t.target)?"src":null}d.default({pkg:{name:"@io-arc/static-files-meta-scraping",version:"1.0.0"}}).notify(),process.stdin.resume(),process.on("SIGINT",(()=>{console.log(e.bold("Bye !")),process.exit(0)})),t.program.version("1.0.0").option("-e, --ext <extensions>","Search target extensions. e.g. html,css",void 0).option("-d, --dir <target directory>","Search target directory",void 0).parse(process.argv),(async t=>{const e=new b({ext:t.ext,dir:t.dir}),r=new F(e.targetDir(),e.targetExt()).exec(e.searchProperties());new E(r,e.searchProperties()).write(),process.exit(0)})(t.program.opts());
