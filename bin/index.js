#!/usr/bin/env node
/*!
@io-arc/static-files-meta-scraping
Analyze static files and extract meta information.

Version: 1.0.0
License: MIT
Documents: https://github.com/io-arc/static-files-meta-scraping

Copyright (c) 2021 arc one
*/
"use strict";var t=require("commander"),e=require("kleur"),r=require("update-notifier"),a=require("fs"),s=require("os"),i=require("path"),o=require("downloads-folder"),n=require("pug"),l=require("cheerio"),c=require("cli-progress"),u=require("glob");function g(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var d=g(r),p=g(a),h=g(s),m=g(i),f=g(o),y=g(n),x=g(l),v=g(c),w=g(u);const b={search:[{target:"html[lang]",value:"lang"},{target:"head[prefix]",value:"prefix"},{target:"title"},{target:'meta[name="description"]'},{target:'meta[property="og:type"]'},{target:'meta[property="og:url"]'},{target:'meta[property="og:title"]'},{target:'meta[property="og:site_name"]'},{target:'meta[property="og:image"]'},{target:'meta[property="og:description"]'},{target:'meta[property="fb:app_id"]'},{target:'meta[name="twitter:card"]'},{target:'meta[name="twitter:site"]'},{target:'meta[name="twitter:creator"]'},{target:'meta[name="twitter:image"]'},{target:'meta[name="twitter:description"]'}],ext:"html",dir:"dist",root:"/"},j=/\.[^.]+$/,S=/\.(jpg|jpeg|gif|png|webp|svg)+$/i;class ${exit(t){console.log(e.red("Oops X(")),t&&console.log(e.red(JSON.stringify(t))),process.exit(1)}}class q extends ${#data=b;constructor(t){super();const e=this.#readFile();null!=e&&(this.#data={...this.#data,...e}),null!=t.ext&&(this.#data.ext=t.ext),null!=t.dir&&(this.#data.dir=t.dir),null!=t.root&&(this.#data.root=t.root)}targetExt(){return this.#data.ext}targetDir(){return this.#data.dir}searchProperties(){return this.#data.search}rootPath(){return this.#data.root}#readFile=()=>{const t=m.default.join(process.cwd(),".meta-scraping.json");if(p.default.existsSync(t))return JSON.parse(p.default.readFileSync(t,"utf8"));const e=m.default.join(h.default.homedir(),".meta-scraping.json");return p.default.existsSync(e)?JSON.parse(p.default.readFileSync(e,"utf8")):null}}const E="https://github.com/io-arc/static-files-meta-scraping",k={doctype:"html"};class F extends ${#body;constructor(t){super();const e=y.default.compileFile(m.default.join(__dirname,"templates","base.pug"),k),r=this.#html(t);this.#body=e({htmlItems:r,project:m.default.dirname(E),homepage:E,version:"1.0.0"})}write(t){const r=`${m.default.join(t||f.default(),"result.html")}`;p.default.writeFileSync(r,this.#body),console.log(e.bold(e.green("\nCompleted file wrote."))),console.log(e.bold(e.blue(`Output: ${r}`)))}#html=t=>{const e=t.filter((t=>"html"===t.type)),r=[];return e.forEach((t=>{const e=[];t.data.forEach((t=>e.push({key:t.key,value:t.value,image:t.image}))),r.push({filename:t.filename,result:e})})),r}}class N extends ${#dir="";#files=[];#progress=new v.default.SingleBar({hideCursor:!0},v.default.Presets.shades_classic);constructor(t,e){super();const r=w.default.sync(`${t}/**/*.${/,/.test(e)?`{${e}}`:e}`);this.#files=this.#sort(r),this.#dir=t}exec(t,r){if(0===this.#files.length)return console.log(e.red("No match files.")),[];this.#progress.start(this.#files.length,0);const a=[];return this.#files.forEach((e=>{this.#progress.increment();const s=this.#pickupExt(e);if(null==s)return;const i=p.default.readFileSync(e,"utf8"),o=e.replace(`${this.#dir}/`,"");switch(s){case".css":return;default:const e=this.#html(i,t,r);return void a.push({filename:o,type:"html",data:e})}})),this.#progress.stop(),a}#sort=t=>t.sort(((t,e)=>{const r=j.exec(t),a=j.exec(e);if(!r)return a||t>e?-1:1;if(!a)return 1;const s=r[0],i=a[0];return s!==i?s>i?-1:1:t>e?-1:1}));#html=(t,e,r)=>{const a=x.default.load(t),s=[];return e.forEach((t=>{const e=a(t.target);if(0===e.length)return;const i=this.#attr(t);Array.from(e).forEach((e=>{const o=null==i?a(e).text():a(e).attr(i);if(null!=o)if(/ \d(.*)[a-zA-Z]/.test(o)){o.split(", ").forEach((e=>{const a=e.replace(/ \d(.*)[a-zA-Z]/,""),i=this.#image(a,r);s.push({key:t.target,value:a,image:i})}))}else{const e=this.#image(o,r);s.push({key:t.target,value:o,image:e})}}))})),s};#pickupExt=t=>{const e=j.exec(t);if(null!=e)return e[0]};#attr=t=>null!=t.value?""===t.value?null:t.value:/^meta/.test(t.target)?"content":/^link/.test(t.target)||/^a/.test(t.target)?"href":/^img\[srcset/.test(t.target)?"srcset":/^img/.test(t.target)||/^source/.test(t.target)||/^video/.test(t.target)?"src":null;#image=(t,e)=>{if(!S.test(t))return;t=t.replace(/https?:\/\/(.*?)\//,"").replace(/\?[^.]+$/,""),/^\//.test(t)||(t=`/${t}`);const r=new RegExp(`^${e}`);t=t.replace(r,"");const a=m.default.join(this.#dir,t);if(!p.default.existsSync(a))return"oops";const s=p.default.readFileSync(a,"base64"),i=this.#mime(a);return null==i?"unknown":`data:${i};base64,${s}`};#mime=t=>{const e=t.match(j);if(null!=e)switch(e[0].toLocaleLowerCase()){case".png":return"image/png";case".jpg":case".jpeg":return"image/jpeg";case".gif":return"image/gif";case"webp":return"image/webp";case".svg":return"image/svg+xml";default:return}}}d.default({pkg:{name:"@io-arc/static-files-meta-scraping",version:"1.0.0"}}).notify(),process.stdin.resume(),process.on("SIGINT",(()=>{console.log(e.bold("Bye !")),process.exit(0)})),t.program.version("1.0.0").option("-d, --dir <target directory>","Search target directory",void 0).option("-r, --root <root path>","URL root path",void 0).parse(process.argv),(async t=>{const e=new q({ext:t.ext,dir:t.dir,root:t.root}),r=new N(e.targetDir(),e.targetExt()).exec(e.searchProperties(),e.rootPath());if(0===r.length)return void process.exit(0);new F(r).write(),process.exit(0)})(t.program.opts());
